---
title: "Isolabtion by Distance"
author: "Arthur OulÃ¨s"
format: html
editor: source
---

```{r}
#| label: LoadPackages
#| echo: false

c("here", "tidyverse", "rnaturalearth", "terra", "vcfR", "dartR") |>
  lapply(library, character.only = TRUE)
```

# Load functions

```{r}
#| label: LoadPlot

source(here("functions", "lcwgs_tidy_functions.R"))
source(here("functions", "plot_functions.R"))
```

# All populations

## Prep

### Convert to genlight object for gl.ibd calculations
```{r}
#| echo: false

lcwgs_gl <- here("data", "SNPs", "8-Embiotoca_filtered.vcf.gz") |>
  gl.read.vcf()

lcwgs_gl@other$latlon <- tibble(
  Indiv = lcwgs_gl@ind.names,
  Pop   = lcwgs_gl@pop
  ) |> 
  left_join(
    y = read_csv2(here("data", "low_coverage_sampling.csv")) |>
      select(Popmap, Latitude, Longitude)
  ) |>
  rename(lat = Latitude, lon = Longitude) |> 
  as.data.frame()

lcwgs_gl@pop <- factor(popmap_lcwgs)

lcwgs_gl |> saveRDS(file = here("data", "Embiotoca_lcwgs_gl.rds"))
```

### Send-away code

```{r}
#| echo: false

library(here)
library(dartR)

lcwgs_gl <- readRDS(file = here("data", "Embiotoca_lcwgs_gl.rds"))

IBD <- gl.ibd(lcwgs_gl, coordinates = "latlon")

IBD |> saveRDS(file = here("output", "Embiotocidae_lcwgs_IBD.rds"))

rm(IBD)
```

### Loading data from IBD.R analysis on cluster
```{r}
IBD <- readRDS(here("output", "Embiotocidae_lcwgs_IBD.rds"))
```

## Results
```{r}
vegan::mantel(IBD$Dgen, IBD$Dgeo)

mantel_plot(IBD$Dgeo, IBD$Dgen)
```

## PCA distances

```{r}
pcadapt_lcwgs <- read_rds(here("output", "pcadapt_lcwgs.rds"))
popmap_lcwgs <- popmap_lcwgs <- c(
  rep("bodega_bay",            5), # BB
  rep("big_creek",            13), # BIGC -> BCR
  rep("catalina_island",      11), # CAT
  rep("elkhorn",               6), # ELK
  rep("guadalupe_island",     10), # GUA
  rep("pacific_grove",        13), # HOP -> Pacific Grove PGR 
  rep("isla_san_jeronimo",    11), # ISJ
  rep("laguna_beach",         13), # LB
  rep("point_dume",            5), # PD
  rep("santa_barbara_island", 13), # SB
  rep("san_clemente_island",  10), # SCL
  rep("la_jolla_san_diego",   13), # SD
  rep("tomales_bay",           1), # TB
  rep("redondo_beach",        10), # RB
  rep("santa_cruz_harbour",   10) # SCH
)
```

```{r}
PCA_distance <- tibble(
  PCA1 = pcadapt_lcwgs$scores[, 1],
  PCA2 = pcadapt_lcwgs$scores[, 2],
  PCA3 = pcadapt_lcwgs$scores[, 3],
  PCA4 = pcadapt_lcwgs$scores[, 4],
  pop  = popmap_lcwgs
) |> 
  group_by(pop) |> 
  summarise(
    PCA1_popmean = mean(PCA1),
    PCA2_popmean = mean(PCA2),
    PCA3_popmean = mean(PCA3),
    PCA4_popmean = mean(PCA4)
  ) |>
  column_to_rownames(var = "pop") |> 
  dist()

vegan::mantel(PCA_distance, IBD$Dgeo)

mantel_plot(IBD$Dgeo, PCA_distance)
```

## Manual geographic barrier distance computing

### Computing barrier distance matrix
```{r}
water <- ne_states(
  country     = c("united states of america", "mexico"),
  returnclass = "sv"
) |>
  crop(y = ext(-124,-113, 28.5, 38.5)) |>
  rasterize(y = rast(ext(-124, -113, 28.5, 38.5), ncols = 1100, nrows = 1000)) |> 
  subst(from = NA, to = 2) |> 
  subst(from = 1, to = NA) |> 
  subst(from = 2, to = 1)

barrier_distance <- function(from, to) {
  background <- water
  background[from] <- 2
  grid_map <- gridDist(background, target = 2)
  extract(grid_map, to) |> as.numeric()
}

geo_dist_cells <- here("data", "low_coverage_sampling_sites.csv") |> 
  read_csv2(show_col_types = FALSE) |> 
  select(c(Code, Longitude, Latitude, Popmap)) |> 
  rename(pop = Popmap) |> 
  mutate(
    pop  = as.factor(pop),
    Code = as.factor(Code)
  ) |>
  arrange(pop) |> 
  (\(x) {
    mutate(x, cell_id = cellFromXY(water, as.matrix(x[, 2:3])))
  })() |> 
  pull(cell_id, name = pop)


barrier_dist_mat <- proxy::dist(geo_dist_cells, method = barrier_distance)

rm(geo_dist_cells)
```

### Test if Euclidean and barrrier geographic distances are different
```{r}
mantel_plot(IBD$Dgeo, barrier_dist_mat)
```

### Correlation btw gl.ibd and barrier distances
```{r}
vegan::mantel(barrier_dist_mat, IBD$Dgen)
mantel_plot(barrier_dist_mat, IBD$Dgen)
```

### Correlation btw PCA and barrier distances
```{r}
vegan::mantel(barrier_dist_mat, PCA_distance)
mantel_plot(barrier_dist_mat, PCA_distance)
```

## Geographic distance considering batymetry

```{r}
library(topoDistance)
library(marmap)
```

```{r}
catalina_df_water <- getNOAA.bathy(
    lon1 = -124, lon2 = -115,
    lat1 = 28,   lat2 = 39,
    resolution = .5
  ) |>
  fortify.bathy() |>
  mutate(z = ifelse(z > 0, NA, z)) |> 
  mutate(z = ifelse(z < 0, -z, z)) |> 
  raster::rasterFromXYZ()

coordinates <- here("data", "low_coverage_sampling_sites.csv") |>
  read_csv2() |>
  select(Popmap, Longitude, Latitude) |> 
  mutate(Popmap = as.factor(Popmap)) |> 
  arrange(Popmap) |> 
  column_to_rownames(var = "Popmap") |> 
  as.matrix()
```

```{r}
Topo_Dist_w <- topoDist(catalina_df_water, coordinates, paths = TRUE)
```

```{r}
png(file = here("output", "plots", "IBD_bathy_map.png"), width = 1080, height = 1080)
topoPathMap(catalina_df_water, coordinates, topoPaths = Topo_Dist_w, type = "terrain")
dev.off()
```
```{r}
library(inlabru)
library(tidyterra)

catalina_df <- getNOAA.bathy(
    lon1 = -124, lon2 = -115,
    lat1 = 28,   lat2 = 39,
    resolution = .5
  ) |> 
  fortify.bathy() |>
  mutate(z = ifelse(z > 0, NA, z)) # Remove landmass data

states <- ne_states(
  country     = c("united states of america", "mexico"),
  returnclass = "sf"
)
```

```{r}
bathy_paths <- ggplot() +
  geom_raster(data = catalina_df, mapping = aes(x = x, y = y, fill = z)) +
  scale_fill_hypso_tint_c(palette = "colombia_bathy", limits = range(catalina_df$z, na.rm = TRUE)) +
  geom_sf(data = states) +
  gg(data = Topo_Dist_w[[2]]) +
  geom_point(data = coordinates, mapping = aes(x = Longitude, y = Latitude), size = 2) +
  coord_sf(xlim = c(-124, -115), ylim = c(28, 39), expand = FALSE) +
  labs(x = "Longitude", y = "Latitude")

save_open_plot(
  here("output", "plots", "IBD_bathy_map.png"),
  plot   = bathy_paths,
  width  = 9,
  height = 7
)
```

```{r}
mantel_plot(IBD$Dgeo, barrier_dist_mat)
mantel_plot(IBD$Dgeo, as.dist(Topo_Dist_w[[1]]))
mantel_plot(barrier_dist_mat, as.dist(Topo_Dist_w[[1]]))
```

```{r}
vegan::mantel(IBD$Dgeo, IBD$Dgen)
p1 <- mantel_plot(IBD$Dgeo, IBD$Dgen, xlab = "Euclidean", ylab = "Fst")

vegan::mantel(as.dist(Topo_Dist_w[[1]]), IBD$Dgen)
p2 <- mantel_plot(as.dist(Topo_Dist_w[[1]]), IBD$Dgen, xlab = "Bathy", ylab = "Fst")

vegan::mantel(as.dist(Topo_Dist_w[[1]]), PCA_distance)
p3 <- mantel_plot(as.dist(Topo_Dist_w[[1]]), PCA_distance, xlab = "Bathy", ylab = "PCA")

combined <- p1 + p2 + p3

save_open_plot(
  path   = here("output", "plots", "IBD_all_pops_tests.png"),
  plot   = combined,
  width  = 24,
  height = 8
  )
```


```{r}
rm(combined, p1, p2, p3)
```

# Excluding islanders

## Prep and Send-away

### Prep

```{r}
#| echo: false

lcwgs_gl <- readRDS(file = here("data", "Embiotoca_lcwgs_gl.rds"))

lcwgs_gl_islanders <- lcwgs_gl[!lcwgs_gl$pop %in% c("guadalupe_island", "catalina_island", "san_clemente_island"), ] |>
  gl.filter.monomorphs(lcwgs_gl_islanders, verbose = 5) |> 
  gl.recalc.metrics(lcwgs_gl_islanders, verbose = 5)

lcwgs_gl_islanders@other$latlon <- here("data", "low_coverage_sampling.csv") |> 
  read_csv2() |>
  select(Popmap, Latitude, Longitude) |>
  right_join(tibble(Popmap = pop(lcwgs_gl_islanders))) |> 
  rename(lat = Latitude, lon = Longitude) |> 
  select(-c(Popmap))

saveRDS(
  lcwgs_gl_islanders,
  file = here("data", "Embiotoca_lcwgs_islanders_gl.rds")
)

rm(lcwgs_gl)
```

### Send-away code

```{r}
#| echo: false

lcwgs_gl_islanders <- here("data", "Embiotoca_lcwgs_islanders_gl.rds") |> readRDS()

IBD <- gl.ibd(lcwgs_gl_islanders, coordinates = "latlon")

IBD |> saveRDS(file = here("output", "Embiotocidae_islanders_IBD.rds"))

rm(IBD)
```

## Load cluster analysis results

```{r}
lcwgs_IBD_islanders <- readRDS(
  file = here("output", "Embiotocidae_lcwgs_islanders_IBD.rds")
)
```

## Compute geographic barrier distance
```{r}
geo_dist_cells_islanders <- here("data", "low_coverage_sampling_sites.csv") |> 
  read_csv2(show_col_types = FALSE) |> 
  select(c(Code, Longitude, Latitude, Popmap)) |>
  rename(pop = Popmap) |> 
  filter(
    !pop %in% c("guadalupe_island", "catalina_island", "san_clemente_island")
  ) |> 
  mutate(
    pop  = as.factor(pop),
    Code = as.factor(Code)
  ) |>
  arrange(pop) |> 
  (\(x) mutate(x,
               cell_id = cellFromXY(water, as.matrix(x[, 2:3]))))() |> 
  pull(cell_id, name = pop)

barrier_dist_mat_islanders <- proxy::dist(geo_dist_cells_islanders,
                                          method = barrier_distance)

rm(water)
```

## Compute geographic euclidean distance
```{r}
Dist_geo_isl <- here("data", "low_coverage_sampling_sites.csv") |> 
  read_csv2(show_col_types = FALSE) |> 
  select(c(Code, Longitude, Latitude, Popmap)) |>
  rename(pop = Popmap) |> 
  arrange(pop) |> 
  filter(
    !pop %in% c("guadalupe_island", "catalina_island", "san_clemente_island")
  ) |>
  as.data.frame()

rownames(Dist_geo_isl) <- Dist_geo_isl$pop

Dist_geo_isl <- Dist_geo_isl[, 2:3] |> dist()
```

## Test if Euclidean and barrier geographic distances are different
```{r}
vegan::mantel(Dist_geo_isl, lcwgs_IBD_islanders$Dgeo)
```

## Correlation btw gl.ibd and barrier distances
```{r}
vegan::mantel(barrier_dist_mat_islanders, lcwgs_IBD_islanders$Dgen)
vegan::mantel(Dist_geo_isl, lcwgs_IBD_islanders$Dgen)

mantel_plot(barrier_dist_mat_islanders, lcwgs_IBD_islanders$Dgen)
```

## Correlation btw PCA and barrier distances

```{r}
pcadapt_lcwgs_coast <- read_rds(here("output", "pcadapt_lcwgs_coast.rds"))
popmap_lcwgs_coast <- c(
  rep("bodega_bay",            5), # BB
  rep("big_creek",            13), # BIGC -> BCR
  rep("elkhorn",               6), # ELK
  rep("pacific_grove",        13), # HOP -> Pacific Grove PGR
  rep("isla_san_jeronimo",    11), # ISJ
  rep("laguna_beach",         13), # LB
  rep("point_dume",            5), # PD
  rep("santa_barbara_island", 13), # SB
  rep("la_jolla_san_diego",   13), # SD
  rep("tomales_bay",           1), # TB
  rep("redondo_beach",        10), # RB
  rep("santa_cruz_harbour",   10)  # SCH
)
```

```{r}
PCA_distances_coast <- tibble(
  PCA1 = pcadapt_lcwgs_coast$scores[, 1],
  PCA2 = pcadapt_lcwgs_coast$scores[, 2],
  pop  = popmap_lcwgs_coast
) |> 
  group_by(pop) |> 
  summarise(
    PCA1_popmean = mean(PCA1),
    PCA2_popmean = mean(PCA2)
  ) |> 
  dist()

vegan::mantel(Dist_geo_isl, PCA_distances_coast)
vegan::mantel(barrier_dist_mat_islanders, PCA_distances_coast)

mantel_plot(Dist_geo_isl, PCA_distances_coast)
```

## Geographic distance considering batymetry

```{r}
library(topoDistance)
library(marmap)
```

```{r}
catalina_df_water <- getNOAA.bathy(
    lon1 = -124, lon2 = -115,
    lat1 = 28,   lat2 = 39,
    resolution = .5
  ) |>
  fortify.bathy() |>
  mutate(z = ifelse(z > 0, NA, z)) |> 
  mutate(z = ifelse(z < 0, -z, z)) |> 
  raster::rasterFromXYZ()

coordinates_coast <- here("data", "low_coverage_sampling_sites.csv") |>
  read_csv2() |>
  select(Popmap, Longitude, Latitude) |> 
  mutate(Popmap = as.factor(Popmap)) |> 
  arrange(Popmap) |> 
  filter(
    !Popmap %in% c("guadalupe_island", "catalina_island", "san_clemente_island")
  ) |> 
  column_to_rownames(var = "Popmap") |> 
  as.matrix()
```

```{r}
Topo_Dist_w_coast <- topoDist(catalina_df_water, coordinates_coast, paths = TRUE)
```

```{r}
bathy_paths_coast <- ggplot() +
  geom_raster(data = catalina_df, mapping = aes(x = x, y = y, fill = z)) +
  scale_fill_hypso_tint_c(palette = "colombia_bathy", limits = range(catalina_df$z, na.rm = TRUE)) +
  geom_sf(data = states) +
  gg(data = Topo_Dist_w_coast[[2]]) +
  geom_point(data = coordinates_coast, mapping = aes(x = Longitude, y = Latitude), size = 2) +
  coord_sf(xlim = c(-124, -115), ylim = c(28, 39), expand = FALSE) +
  labs(x = "Longitude", y = "Latitude")

save_open_plot(
  here("output", "plots", "IBD_bathy_map_coast.png"),
  plot   = bathy_paths_coast,
  width  = 9,
  height = 7
)
```

```{r}
mantel_plot(Dist_geo_isl, barrier_dist_mat_islanders)
mantel_plot(Dist_geo_isl, as.dist(Topo_Dist_w_coast[[1]]))
mantel_plot(barrier_dist_mat_islanders, as.dist(Topo_Dist_w_coast[[1]]))
```

```{r}
vegan::mantel(Dist_geo_isl, lcwgs_IBD_islanders$Dgen)
p1 <- mantel_plot(Dist_geo_isl, lcwgs_IBD_islanders$Dgen, xlab = "Euclidean", ylab = "Fst")

vegan::mantel(as.dist(Topo_Dist_w_coast[[1]]), lcwgs_IBD_islanders$Dgen)
p2 <- mantel_plot(as.dist(Topo_Dist_w_coast[[1]]), lcwgs_IBD_islanders$Dgen, xlab = "Bathy", ylab = "Fst")

vegan::mantel(as.dist(Topo_Dist_w_coast[[1]]), PCA_distances_coast)
p3 <- mantel_plot(as.dist(Topo_Dist_w_coast[[1]]), PCA_distances_coast, xlab = "Bathy", ylab = "PCA")

combined <- p1 + p2 + p3

save_open_plot(
  path   = here("output", "plots", "IBD_coast_pops_tests.png"),
  plot   = combined,
  width  = 24,
  height = 8
  )
```

```{r}
rm(combined, p1, p2, p3)
```

## Tree tests

```{r}
IBD$Dgen |> nj() |> root(outgroup = "guadalupe_island") |> ladderize() |> plot()
```

```{r}
PCA_distance <- tibble(
  PCA1 = pcadapt_lcwgs$scores[, 1],
  PCA2 = pcadapt_lcwgs$scores[, 2],
  PCA3 = pcadapt_lcwgs$scores[, 3],
  pop  = popmap_lcwgs
) |> 
  group_by(pop) |> 
  summarise(
    PCA1_popmean = mean(PCA1),
    PCA2_popmean = mean(PCA2),
    PCA3_popmean = mean(PCA3)
  ) |>
  column_to_rownames(var = "pop") |> 
  dist()
```


```{r}
PCA_distance |> nj() |> root(outgroup = "guadalupe_island") |> ladderize() |> plot()
```



